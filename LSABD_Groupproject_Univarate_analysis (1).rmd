---
title: "LSABD_Groupproject_univarate_analysis"
output: html_document
date: "2025-11-26"
---

#1 Code from the data exploration as basis to start the univariate analysis on:
In this univariate analysis, we aim to asses whether the protein with the highest overall variability in abundance differs between the COVID-severity groups.
```{r}
# import libraries
library(tidyverse)
library(ComplexHeatmap)
library(stats)

# Import data sets
combined_dataset <- read.csv("combined_dataset.csv")
features_somameres <- read.csv("feature_meta.csv")

# Split the combined_dataset in protein expression levels and meta data
combined_dataset_protein <-combined_dataset[,1:7241]
combined_dataset_features <-combined_dataset[,7242:7258]

# Columns: sex, ethnicity, ... converted to factors
clinical_data <- c("ethnicity", "sex", "ihd", "previous_vte","copd", "diabetes", "smoking", "cause_eskd", "WHO_severity", "case_control","radiology_evidence_covid", "fatal_disease")
combined_dataset_features[clinical_data] <- lapply((combined_dataset_features[clinical_data]),factor)

# Convert the WHO_temp_severity column to a ranked column NEGATIVE = 1, mild = 2, moderate = 3, severe = 4, critical = 5
combined_dataset_features$WHO_temp_severity <- factor(
  combined_dataset_features$WHO_temp_severity,
  levels = c("NEGATIVE", "mild", "moderate", "severe", "critical"), ordered = TRUE)
str(combined_dataset_features)

# Log transforming and scale data 
proteins_log <- log(combined_dataset_protein[,2:7241])
protein_scaled <- as.data.frame(scale(proteins_log))
proteins_scaled_ids <- protein_scaled %>% mutate(X = combined_dataset_protein$X) %>% relocate(X, .before = 1)
proteins_log_ids <- proteins_log %>% mutate(X = combined_dataset_protein$X) %>% relocate(X, .before = 1)

# Boxplot from a selection of proteins after scaling
proteins_scaled_ids[,1:10] %>% pivot_longer(!X, names_to = "prots", values_to = "abundances") %>%
  ggplot(aes(x= prots, y = abundances))+
  geom_boxplot()
```
```{r}
# Visualisation from the distribution of WHO_temp_severety
combined_dataset_features %>% 
  ggplot(aes(x = WHO_temp_severity)) + 
  geom_bar(fill = "steelblue") + 
  theme_minimal() +
  labs(title = "Distribution of WHO_temp_severity", x = "WHO_temp_severity", y = "Count")
```
#2 Identifying the most variable protein: 
```{r}
# Variances of proteins
cv <- function (x) {sd(x, na.rm = TRUE) / mean(x, na.rm = TRUE) * 100}

IQR_per_protein <- proteins_scaled_ids %>% pivot_longer(!X, names_to = "prots", values_to = "abundances") %>%
  group_by(prots) %>%
  summarise(IQR = IQR(abundances)) %>%
  arrange(desc(IQR))

# The top 10 proteins with the highest inter queartile range
IQR_per_protein[1:5,] 

IQR_per_protein[1:10,] %>% ggplot(aes(x = prots, y = IQR)) + 
  geom_bar(fill = "steelblue", stat="identity", width = 0.5) + 
  theme_minimal() +
  labs(title = "Proteins with highes interquantile range (IQR)", x = "Protein name", y = "IQR")
```
Based on the IQR we will conclude that MX1 has the highest variable expression among all samples (IQR = 2.103544), although the difference with the IQR of other proteins is verry small. To further asses the variability of protein abundance we performed a DEA, this reinforced the previous observation. In the DEA we compared the covid positives and negatives, the vulcano plot shows MX1 as the most differential expressed protein.

```{r}
#install.packages("BiocManager")
#BiocManager::install("edgeR")
library(edgeR)

# transpose the combined_dataset_protein, this is needed for a DEA.
n <- combined_dataset_protein$X
transposed_proteins <- as.data.frame(t(combined_dataset_protein[,-1]))
colnames(transposed_proteins) <- n

# Make a DEA matrix, and log transform it
counts_matrix <- as.matrix(transposed_proteins)
dge <- DGEList(counts = counts_matrix, group = combined_dataset_features$case_control)
log_voom_matrix <- voom(dge)

# Design and contrast matrix
design <- model.matrix(~0 + case_control, data=combined_dataset_features)

# Define the contrast
contrast.matrix_negpos <- makeContrasts(contrast1=case_controlNEGATIVE-case_controlPOSITIVE, levels=design)


## Fit model & perform differential expression
#fitting the expression matrix to linear models
fit <- lmFit(log_voom_matrix, design)
#compute contrast
fit_negpos <- contrasts.fit(fit, contrast.matrix_negpos)
#Bayes statistic of differential expression
fit_negpos <- eBayes(fit_negpos)

volcanoplot(fit_negpos, coef=1, highlight = 1, names=rownames(fit_negpos))

```
CONCLUSION: We will use MX1 in this univariate analysis

#3 Hypotheses
In this univariate analysis, we aim to asses whether MX1 abundance differs between the COVID-severity groups.
Null hypothesis (H₀): There is no difference in MX1 expression levels across all 5 severity groups.
Alternative hypothesis (H₁): There is a difference in MX1 expression levels between the 5 severity groups.

# anova test-> statistical test to check that the protein expression levels in different stages of severity is significantly different ? 
Dependent variable (DV): Protein expression levels of MX1 (continuous data).
Independent variable (IV): Severity groups (categorical, e.g., mild, moderate, severe). -> uitleg wrm 

In order to perform an ANOVA test, we need to check the assumptions for this test.
1. Normality of the protein expression
2. Homogeneity of variance between groups
3. Independence of the groups

```{r}
# Make a dataframe with only the MX1 expression pre sample and the coresponding WHO_temp_severety
df_univariate_analysis_scaled <- proteins_scaled_ids %>% select(X, MX1) %>% mutate(WHO_temp_severity = combined_dataset_features$WHO_temp_severity)
df_univariate_analysis_log <- proteins_log_ids%>% select(X, MX1) %>% mutate(WHO_temp_severity = combined_dataset_features$WHO_temp_severity)

# 1.1 normaility within the group

df_univariate_analysis_scaled %>% ggplot(aes(sample = MX1)) +
  stat_qq() +
  stat_qq_line() +
  labs(title = "QQ-Plot all severity groups")

df_univariate_analysis_scaled %>% ggplot(aes(sample = MX1)) +
  stat_qq() +
  stat_qq_line()+
  facet_wrap(~WHO_temp_severity)+
  labs(title = "Individual QQ-Plots per severity group")

# 2 Homogeneity of variance between groups in standardised data
df_univariate_analysis_scaled %>% ggplot(mapping = aes (x= WHO_temp_severity, y= MX1, fill = WHO_temp_severity)) +
  geom_boxplot (outliers = FALSE) +
  geom_jitter (color="black", width = 0.15) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  xlab("COVID-severity group")+
  ylab("Log-transformed, standardised MX1 abundance")+
  labs(title = "MX1 abundance per severity group")
```
Evaluation assumptions:
1. Normality of the protein expression
    This assumption is not satisfied, as can be seen in the qqplot.  
2. Homogeneity of variance between groups
    This assumption is not satisfied, the variance in the negative group is drastically lower than in other groups.
3. Independence of the groups
    For the sake of the exercise we will assume the samples are independent, so the goups are independent
This means, we can not perform an ANOVA test to evaluate the difference in MX1 expression in the different groups.

Therefore we will perform a Kruskal-Wallis test, the non parametrical counterpart of the ANOVA. This test does not assume normality and homogeneity of variance. 
The hypothesis stay the same.
Null hypothesis (H₀): There is no difference in MX1 expression levels across all 5 severity groups.
Alternative hypothesis (H₁): There is a difference in MX1 expression levels between the 5 severity groups.



```{r}
kw_results <- kruskal.test(df_univariate_analysis_scaled, MX1~WHO_temp_severity)
kw_results

#install.packages("dunn.test")
library(dunn.test)

attach(df_univariate_analysis_scaled)
dunn_results <- dunn.test(MX1, WHO_temp_severity, method =  "bonferroni")

dunn_results_df <- data.frame(comparisons = dunn_results$comparisons, 
           p_value = dunn_results$P.adjusted,
           z_value = dunn_results$Z) %>%
  arrange(comparisons)
dunn_results_df
```

```{r}
## Calculating confidence intervals of differences in mean protein abundance to support the post-hoc analysis

data <- df_univariate_analysis_scaled %>% select(WHO_temp_severity, MX1)

# Function to calculate confidence interval for difference in means
calculate_ci <- function(data, group1, group2, conf_level = 0.95) {
  x1 <- data[data$WHO_temp_severity == group1, "MX1"]
  x2 <- data[data$WHO_temp_severity == group2, "MX1"]

  n1 <- length(x1)
  n2 <- length(x2)

  mean1 <- mean(x1)
  mean2 <- mean(x2)
  
  mean_diff <- mean1 - mean2

  sd1 <- sd(x1)
  sd2 <- sd(x2)
  
  var1 <- var(x1)
  var2 <- var(x2)

  # Pooled variance
  sp2 <- ((n1 - 1) * var1 + (n2 - 1) * var2) / (n1 + n2 - 2)

  # t-critical value
  t_critical <- qt(conf_level, n1 + n2 - 2)

  # Standard error
  se <- sqrt(sp2 * (1/n1 + 1/n2))
  #se <- sqrt(sd1/n1 + sd2/n2)

  t_se <- t_critical * se
  
  # Confidence interval
  lwr <- mean_diff -  t_se
  upr <- mean_diff +  t_se
  
  return(c(mean_diff, t_se))
}

# List of groups
groups <- c("NEGATIVE", "mild", "moderate", "severe", "critical")

# Generate all possible pairs of groups
pairs <- t(combn(groups, 2))

# Calculate confidence intervals for each pair
confidence_intervals <- apply(pairs, 1, function(pair) {
  ci <- calculate_ci(data, pair[1], pair[2])
  return(c(pair[1], pair[2], ci))
})

# Convert to a data frame for readability
confidence_intervals_df <- data.frame(matrix(unlist(confidence_intervals), nrow = nrow(pairs), byrow = TRUE),
                                       stringsAsFactors = FALSE)

colnames(confidence_intervals_df) <- c("Group1", "Group2", "mean_diff", "t_se")

confidence_intervals_df <- confidence_intervals_df %>% 
  mutate(mean_diff = as.double(mean_diff), t_se = as.double(t_se))%>% 
  mutate(comparison = paste(Group1, Group2, sep = ' - '), lwr = mean_diff - t_se, upr = mean_diff + t_se) %>% 
  relocate(comparison, .before = 3 )

# View the results
print(confidence_intervals_df)

# Visualise CIs
ggplot(confidence_intervals_df, aes(x = comparison, y = mean_diff)) +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  geom_point() +
  geom_errorbar(aes(ymin = lwr, ymax = upr), width = 0.2) +
  labs(title = "Confidence Intervals for Mean Differences of MX1 abundance",
       x = "Comparison",
       y = "Log-transformed, standardised MX1 abundance") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Coclusion:
The Kruskal-Wallis test revealed an extremely significant difference in MX1 expression across COVID-19 severity groups (p < 0.0001). MX1 abundance in COVID-negative patients differed extremely significantly from all COVID-positive groups: mild COVID (p < 0,0001, 95% CI = 1.27±0.23), moderate COVID (p < 0,0001, 95% CI = 1.69±0.18), severe COVID (p < 0,0001, 95% CI = 2.08±0.15), critical COVID (p<0,0001, CI = 1.68±0.23).  Additionally, a significant difference was observed between the mild and severe COVID groups (p<0,001, CI = 0.80±0.32). These results are clearly illustrated in the boxplots (Fig …).
